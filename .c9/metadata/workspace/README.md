{"changed":true,"filter":false,"title":"README.md","tooltip":"/README.md","value":"# Composer Docker POC\n\nThis repository holds a proof of concept as to how you can use one single\nrepository as a full build, test and deploy system. It is focused on being\nlight, fast and able to be setup without any additional configuraiton. \n\n## Concept introduction\n\nPhase one of the concept is to ensure the architecture of the controller\ncomponents (git, composer and docker-compose) always result in a functional\nproject.\n\n- `git checkout` **=>** `composer install` **=>** `docker-compose up -d`\n\nThis action should always result in a functional project regardless of which\nenvironment it was executed for. The master branch should always be fully built.\nThis branch/codebase/environment will act as the baseline on which people will\nbase their development, testing or deployment. When in development mode you can\nalways simulate testing or deployment in the exact way it will be deployed on\nproduction.\n\n### Development environment\nAnyone that is given write access should automatically receive any and all tools\nthat they need to perform development with. In this example we will use a\nCloud9 local editor that will be automatically connected to the environment that\nthe git branch is running on To accomplish this we need to provide some data:\n- sanitized database of production\n- \n\n\n\n## Host binary requirements\n\n### 1. Docker\n> The endgoal is to have docker as the only requirement on the host system. To\naccomplish this the requirements below have to be provided by docker itself. If\nthis goal is reached any and all incompatibilities of developers trying to use\ntheir own development environment are abolished. The quote \"It works on my\nmachine.\" will be a thing of the past.\n\n### 2. Docker Compose\n> This requirement can be eventually dropped if it is made compatible with Docker\nStack. Dropping this requirement is being postponed because I do not have\nsufficient knowledge yet on the latest version of Docker that provides the Docker\nStack functionality which does the same and more natively as what Docker Compose\nbrings to the table.\n\n### 3. Composer\n> <details><summary>Composer is the main component for building the codebase(s).\n> The host system should provide it. But the ideal situation would be for the\n> project to define composer as a service in its docker-compose.yml file and the\n> host system will executed composer with the version defined in the\n> docker-compose.yml file if any is present in the working directory. This\n> approach is only possible if the codebase is already on the host system. So\n> probably we would have to implement a bash function that checks for the\n> presence of a docker-compose.yml service and fallback to its own\n> docker-compose service.</summary>\n> \n> ```shell\n> #!/bin/bash\n> alias composer=\"docker-compose exec composer\" \n> ```\n> </details>\n\n### 4. Git\n> <details><summary>Same concept as Composer should be pursued. By letting\n> docker handle the Git requirement any project will be able to select their own\n> version of Git, which plugins they wish to use and what hooks they wish to\n> execute. This approach is only possible if the codebase is already on the host\n> system. So probably we would have to implement a bash function that checks for\n> the presence of a docker-compose.yml service and fallback to its own\n> docker-compose service.</summary>\n> \n> ```shell\n> #!/bin/bash\n> alias git=\"docker-compose exec git\" \n> ```\n> </details>\n\n## Project source code requirements\n\n### 1. .gitignore\n> <details><summary>The projects for the Docker only architecture are very\n> sensitive to folder structure and file changes. To force developers to keep the\n> repository clean and organised the .gitignore file applies a full blacklist and\n> individual whitelisting.</summary>\n> \n> ```shell\n> # Blacklist everything.\n> /**\n> # Whitelist each individual file or folder.\n> !/README.md\n> !/composer.json\n> !/composer.lock\n> !/docker-compose.yml\n> ```\n> </details>\n\n\n### 2. composer.json\n> <details><summary>The composer.json file is responsable for generating all\n> codebases. The component that will provide this task is\n> verbruggenalex/composer-project-builder-plugin. To keep the project footprint\n> as light as possible the following architecture is set up.</summary>\n> \n> ```javascript\n> {\n>     \"require\": {\n>         \"drush/drush\": \"8.*\",\n>         \"drupal/drupal\": \"~7.0\",\n>         \"verbruggenalex/composer-project-builder-plugin\": \"dev-master\"\n>     }\n> }\n> ```\n> </details>\n\n### 3. docker-compose.yml\n> <details><summary>The docker-compose.yml file has to contain all service\n> required for the project to run. Extra services can be provided as helper\n> services that developers can enable themselves.</summary>\n> \n> ```yaml\n> version: '3'\n> services:\n> \n>   # Images should not contain non dependant components inside like phpmyadmin.\n>   # It's better to move it to its own dedicated service so developers can save\n>   # diskspace if they are not planning to use the service.\n>   web:\n>     image: fpfis/php71-dev-7\n>     environment:\n>       - DOCUMENT_ROOT=${PWD}/build/master/web\n>     working_dir: ${PWD}/build/master/web\n>     volumes:\n>       - ${PWD}:${PWD}\n>     links:\n>       - mysql:mysql\n>     labels:\n>       - 'traefik.backend=web'\n>       - 'traefik.port=8080'\n>       - 'traefik.frontend.rule=Host:${PROJECT_BASE_URL:-dev.local}'\n> \n>   # All variables should be providing a default value. This allows for the\n>   # same docker-compose.yml file to be used for development, testing and\n>   # deployment.\n>   mysql:\n>     image: mysql:5.7\n>     restart: always\n>     environment:\n>       - MYSQL_DATABASE=${MYSQL_DATABASE:-database}\n>       - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD:-password}\n>       - MYSQL_USER=${MYSQL_USER:-root}\n>       - MYSQL_PASSWORD=${MYSQL_PASSWORD:-password}\n>     volumes:\n>       - \"./build/master/data/db/mysql:/var/lib/mysql\"\n> \n>   # Cloud9 needs to be patched to allow it to connect the shell to the service\n>   # that is running the project. In this case the web service. Currently we\n>   # mount docker binaries and socket to allow the native Cloud9 shell to access\n>   # services within the project.\n>   cloud9:\n>     image: eeacms/cloud9\n>     environment:\n>       - C9_WORKSPACE=${PWD}\n>     volumes:\n>       - ${PWD}:${PWD}\n>       - /usr/bin/docker:/usr/bin/docker\n>       - /usr/local/bin/docker-compose:/usr/local/bin/docker-compose\n>       - /var/run/docker.sock:/var/run/docker.sock\n>     links:\n>       - web:web\n>     labels:\n>       - 'traefik.backend=cloud9'\n>       - 'traefik.port=8080'\n>       - 'traefik.frontend.rule=Host:cloud9.${PROJECT_BASE_URL:-dev.local}'\n> \n>   # PHPMyAdmin is added as an example service that developers can use who do\n>   # not have knowledge in using MySQL CLI commands to perform their tasks.\n>   pma:\n>     image: phpmyadmin/phpmyadmin\n>     environment:\n>       PMA_HOST: mysql\n>       PMA_USER: ${MYSQL_USER:-root}\n>       PMA_PASSWORD: ${MYSQL_ROOT_PASSWORD:-password}\n>       PHP_UPLOAD_MAX_FILESIZE: 1G\n>       PHP_MAX_INPUT_VARS: 1G\n>     labels:\n>       - 'traefik.backend=pma'\n>       - 'traefik.port=80'\n>       - 'traefik.frontend.rule=Host:pma.${PROJECT_BASE_URL:-dev.local}'\n> \n>   # Services are exposed to a certain domain by traefik. This allows\n>   # developers to spawn a project on a domain and easily know where to access\n>   # their services.\n>   traefik:\n>     image: traefik\n>     command: -c /dev/null --web --docker --logLevel=INFO\n>     ports:\n>       - '8000:80'\n>       - '8080:8080' # Dashboard\n>     volumes:\n>       - /var/run/docker.sock:/var/run/docker.sock\n> ```\n> </details>\n\n## Project workflow\n\n### 1. Git\n> <details><summary>Git is the initial starting point for any codebase. So we\n> want Git to be the main controller to help the developers build their\n> codebase. Composer will be responsible for building the codebase. So a simple\n> Git hook that calls <code>composer install</code> whenever we change branch\n> will immediately setup a new build for us. Click to see example of a <code>\n> post-checkout</code> Git hook.</summary>\n>\n> ```shell\n> #!/bin/bash\n> [ -f composer.json ] && composer install\n> ```\n> </details>\n\n### 2. Composer\n> <details><summary>Composer is the secondary controller. Once we have a\n> codebase available we require an environment to run the project on. The\n> Composer hooks can run <code>docker-compose up -d</code> for us and we will\n> have immediate access to our development environment.</summary>\n>\n> ```javascript\n>     \"scripts\": {\n>        \"post-install-cmd\": [\n>            \"docker-compose up -d\"\n>        ]\n>    }\n> ```\n> </details>","undoManager":{"mark":-2689,"position":100,"stack":[[{"start":{"row":25,"column":38},"end":{"row":25,"column":39},"action":"insert","lines":["l"],"id":2777}],[{"start":{"row":25,"column":39},"end":{"row":25,"column":40},"action":"insert","lines":["i"],"id":2778}],[{"start":{"row":25,"column":40},"end":{"row":25,"column":41},"action":"insert","lines":["s"],"id":2779}],[{"start":{"row":25,"column":41},"end":{"row":25,"column":42},"action":"insert","lines":["h"],"id":2780}],[{"start":{"row":25,"column":42},"end":{"row":25,"column":43},"action":"insert","lines":[" "],"id":2781}],[{"start":{"row":25,"column":43},"end":{"row":25,"column":44},"action":"insert","lines":["t"],"id":2782}],[{"start":{"row":25,"column":44},"end":{"row":25,"column":45},"action":"insert","lines":["h"],"id":2783}],[{"start":{"row":25,"column":45},"end":{"row":25,"column":46},"action":"insert","lines":["i"],"id":2784}],[{"start":{"row":25,"column":46},"end":{"row":25,"column":47},"action":"insert","lines":["s"],"id":2785}],[{"start":{"row":25,"column":47},"end":{"row":25,"column":48},"action":"insert","lines":[" "],"id":2786}],[{"start":{"row":25,"column":48},"end":{"row":25,"column":49},"action":"insert","lines":["w"],"id":2787}],[{"start":{"row":25,"column":49},"end":{"row":25,"column":50},"action":"insert","lines":["e"],"id":2788}],[{"start":{"row":25,"column":50},"end":{"row":25,"column":51},"action":"insert","lines":[" "],"id":2789}],[{"start":{"row":25,"column":51},"end":{"row":25,"column":52},"action":"insert","lines":["n"],"id":2790}],[{"start":{"row":25,"column":52},"end":{"row":25,"column":53},"action":"insert","lines":["e"],"id":2791}],[{"start":{"row":25,"column":52},"end":{"row":25,"column":53},"action":"remove","lines":["e"],"id":2792}],[{"start":{"row":25,"column":51},"end":{"row":25,"column":52},"action":"remove","lines":["n"],"id":2793}],[{"start":{"row":25,"column":50},"end":{"row":25,"column":51},"action":"remove","lines":[" "],"id":2794}],[{"start":{"row":25,"column":50},"end":{"row":25,"column":51},"action":"insert","lines":[" "],"id":2795}],[{"start":{"row":25,"column":51},"end":{"row":25,"column":52},"action":"insert","lines":["w"],"id":2796}],[{"start":{"row":25,"column":51},"end":{"row":25,"column":52},"action":"remove","lines":["w"],"id":2797}],[{"start":{"row":25,"column":51},"end":{"row":25,"column":52},"action":"insert","lines":["n"],"id":2798}],[{"start":{"row":25,"column":52},"end":{"row":25,"column":53},"action":"insert","lines":["e"],"id":2799}],[{"start":{"row":25,"column":53},"end":{"row":25,"column":54},"action":"insert","lines":["e"],"id":2800}],[{"start":{"row":25,"column":54},"end":{"row":25,"column":55},"action":"insert","lines":["d"],"id":2801}],[{"start":{"row":25,"column":55},"end":{"row":25,"column":56},"action":"insert","lines":[" "],"id":2802}],[{"start":{"row":25,"column":56},"end":{"row":25,"column":57},"action":"insert","lines":["t"],"id":2803}],[{"start":{"row":25,"column":57},"end":{"row":25,"column":58},"action":"insert","lines":["o"],"id":2804}],[{"start":{"row":25,"column":58},"end":{"row":25,"column":59},"action":"insert","lines":[" "],"id":2805}],[{"start":{"row":25,"column":59},"end":{"row":25,"column":60},"action":"insert","lines":["p"],"id":2806}],[{"start":{"row":25,"column":60},"end":{"row":25,"column":61},"action":"insert","lines":["r"],"id":2807}],[{"start":{"row":25,"column":61},"end":{"row":25,"column":62},"action":"insert","lines":["o"],"id":2808}],[{"start":{"row":25,"column":62},"end":{"row":25,"column":63},"action":"insert","lines":["v"],"id":2809}],[{"start":{"row":25,"column":63},"end":{"row":25,"column":64},"action":"insert","lines":["i"],"id":2810}],[{"start":{"row":25,"column":64},"end":{"row":25,"column":65},"action":"insert","lines":["d"],"id":2811}],[{"start":{"row":25,"column":65},"end":{"row":25,"column":66},"action":"insert","lines":["e"],"id":2812}],[{"start":{"row":25,"column":66},"end":{"row":25,"column":67},"action":"insert","lines":[" "],"id":2813}],[{"start":{"row":25,"column":67},"end":{"row":25,"column":68},"action":"insert","lines":["s"],"id":2814}],[{"start":{"row":25,"column":68},"end":{"row":25,"column":69},"action":"insert","lines":["o"],"id":2815}],[{"start":{"row":25,"column":69},"end":{"row":25,"column":70},"action":"insert","lines":["m"],"id":2816}],[{"start":{"row":25,"column":70},"end":{"row":25,"column":71},"action":"insert","lines":["e"],"id":2817}],[{"start":{"row":25,"column":71},"end":{"row":25,"column":72},"action":"insert","lines":[" "],"id":2818}],[{"start":{"row":25,"column":72},"end":{"row":25,"column":73},"action":"insert","lines":["r"],"id":2819}],[{"start":{"row":25,"column":73},"end":{"row":25,"column":74},"action":"insert","lines":["e"],"id":2820}],[{"start":{"row":25,"column":74},"end":{"row":25,"column":75},"action":"insert","lines":["s"],"id":2821}],[{"start":{"row":25,"column":75},"end":{"row":25,"column":76},"action":"insert","lines":["o"],"id":2822}],[{"start":{"row":25,"column":76},"end":{"row":25,"column":77},"action":"insert","lines":["u"],"id":2823}],[{"start":{"row":25,"column":77},"end":{"row":25,"column":78},"action":"insert","lines":["r"],"id":2824}],[{"start":{"row":25,"column":78},"end":{"row":25,"column":79},"action":"insert","lines":["c"],"id":2825}],[{"start":{"row":25,"column":79},"end":{"row":25,"column":80},"action":"insert","lines":["e"],"id":2826}],[{"start":{"row":25,"column":79},"end":{"row":25,"column":80},"action":"remove","lines":["e"],"id":2827}],[{"start":{"row":25,"column":78},"end":{"row":25,"column":79},"action":"remove","lines":["c"],"id":2828}],[{"start":{"row":25,"column":77},"end":{"row":25,"column":78},"action":"remove","lines":["r"],"id":2829}],[{"start":{"row":25,"column":76},"end":{"row":25,"column":77},"action":"remove","lines":["u"],"id":2830}],[{"start":{"row":25,"column":75},"end":{"row":25,"column":76},"action":"remove","lines":["o"],"id":2831}],[{"start":{"row":25,"column":74},"end":{"row":25,"column":75},"action":"remove","lines":["s"],"id":2832}],[{"start":{"row":25,"column":73},"end":{"row":25,"column":74},"action":"remove","lines":["e"],"id":2833}],[{"start":{"row":25,"column":72},"end":{"row":25,"column":73},"action":"remove","lines":["r"],"id":2834}],[{"start":{"row":25,"column":72},"end":{"row":25,"column":73},"action":"insert","lines":["d"],"id":2835}],[{"start":{"row":25,"column":73},"end":{"row":25,"column":74},"action":"insert","lines":["a"],"id":2836}],[{"start":{"row":25,"column":74},"end":{"row":25,"column":75},"action":"insert","lines":["t"],"id":2837}],[{"start":{"row":25,"column":75},"end":{"row":25,"column":76},"action":"insert","lines":["a"],"id":2838}],[{"start":{"row":25,"column":76},"end":{"row":25,"column":77},"action":"insert","lines":["."],"id":2839}],[{"start":{"row":25,"column":76},"end":{"row":25,"column":77},"action":"remove","lines":["."],"id":2840}],[{"start":{"row":25,"column":76},"end":{"row":25,"column":77},"action":"insert","lines":[":"],"id":2841}],[{"start":{"row":25,"column":77},"end":{"row":26,"column":0},"action":"insert","lines":["",""],"id":2842}],[{"start":{"row":26,"column":0},"end":{"row":26,"column":1},"action":"insert","lines":["-"],"id":2843}],[{"start":{"row":26,"column":1},"end":{"row":26,"column":2},"action":"insert","lines":[" "],"id":2844}],[{"start":{"row":26,"column":2},"end":{"row":26,"column":3},"action":"insert","lines":["s"],"id":2845}],[{"start":{"row":26,"column":3},"end":{"row":26,"column":4},"action":"insert","lines":["a"],"id":2846}],[{"start":{"row":26,"column":4},"end":{"row":26,"column":5},"action":"insert","lines":["n"],"id":2847}],[{"start":{"row":26,"column":5},"end":{"row":26,"column":6},"action":"insert","lines":["i"],"id":2848}],[{"start":{"row":26,"column":6},"end":{"row":26,"column":7},"action":"insert","lines":["t"],"id":2849}],[{"start":{"row":26,"column":7},"end":{"row":26,"column":8},"action":"insert","lines":["i"],"id":2850}],[{"start":{"row":26,"column":8},"end":{"row":26,"column":9},"action":"insert","lines":["z"],"id":2851}],[{"start":{"row":26,"column":9},"end":{"row":26,"column":10},"action":"insert","lines":["e"],"id":2852}],[{"start":{"row":26,"column":10},"end":{"row":26,"column":11},"action":"insert","lines":["d"],"id":2853}],[{"start":{"row":26,"column":11},"end":{"row":26,"column":12},"action":"insert","lines":[" "],"id":2854}],[{"start":{"row":26,"column":12},"end":{"row":26,"column":13},"action":"insert","lines":["d"],"id":2855}],[{"start":{"row":26,"column":13},"end":{"row":26,"column":14},"action":"insert","lines":["a"],"id":2856}],[{"start":{"row":26,"column":14},"end":{"row":26,"column":15},"action":"insert","lines":["t"],"id":2857}],[{"start":{"row":26,"column":15},"end":{"row":26,"column":16},"action":"insert","lines":["a"],"id":2858}],[{"start":{"row":26,"column":16},"end":{"row":26,"column":17},"action":"insert","lines":["b"],"id":2859}],[{"start":{"row":26,"column":17},"end":{"row":26,"column":18},"action":"insert","lines":["a"],"id":2860}],[{"start":{"row":26,"column":18},"end":{"row":26,"column":19},"action":"insert","lines":["s"],"id":2861}],[{"start":{"row":26,"column":19},"end":{"row":26,"column":20},"action":"insert","lines":["e"],"id":2862}],[{"start":{"row":26,"column":20},"end":{"row":26,"column":21},"action":"insert","lines":[" "],"id":2863}],[{"start":{"row":26,"column":21},"end":{"row":26,"column":22},"action":"insert","lines":["o"],"id":2864}],[{"start":{"row":26,"column":22},"end":{"row":26,"column":23},"action":"insert","lines":["f"],"id":2865}],[{"start":{"row":26,"column":23},"end":{"row":26,"column":24},"action":"insert","lines":[" "],"id":2866}],[{"start":{"row":26,"column":24},"end":{"row":26,"column":25},"action":"insert","lines":["p"],"id":2867}],[{"start":{"row":26,"column":25},"end":{"row":26,"column":26},"action":"insert","lines":["r"],"id":2868}],[{"start":{"row":26,"column":26},"end":{"row":26,"column":27},"action":"insert","lines":["o"],"id":2869}],[{"start":{"row":26,"column":27},"end":{"row":26,"column":28},"action":"insert","lines":["d"],"id":2870}],[{"start":{"row":26,"column":28},"end":{"row":26,"column":29},"action":"insert","lines":["u"],"id":2871}],[{"start":{"row":26,"column":29},"end":{"row":26,"column":30},"action":"insert","lines":["c"],"id":2872}],[{"start":{"row":26,"column":30},"end":{"row":26,"column":31},"action":"insert","lines":["t"],"id":2873}],[{"start":{"row":26,"column":31},"end":{"row":26,"column":32},"action":"insert","lines":["i"],"id":2874}],[{"start":{"row":26,"column":32},"end":{"row":26,"column":33},"action":"insert","lines":["o"],"id":2875}],[{"start":{"row":26,"column":33},"end":{"row":26,"column":34},"action":"insert","lines":["n"],"id":2876}],[{"start":{"row":26,"column":34},"end":{"row":27,"column":0},"action":"insert","lines":["",""],"id":2877},{"start":{"row":27,"column":0},"end":{"row":27,"column":2},"action":"insert","lines":["- "]}]]},"ace":{"folds":[],"scrolltop":192,"scrollleft":0,"selection":{"start":{"row":27,"column":2},"end":{"row":27,"column":2},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":{"row":11,"state":"allowBlock","mode":"ace/mode/markdown"}},"timestamp":1524403536371}